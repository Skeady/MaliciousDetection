import logging
import tempfile
import datetime
from MaliciousDetection import (SystemScanner,
                                VirusTotalUtils,
                                reporting)
logging.getLogger(__name__)


# Used to call the appropriate modules
def run_file_scan(file_path):
    logging.info('Starting SystemScan')
    identified_files = SystemScanner.Scan(file_path)
    logging.info(f'SystemScan identified {len(identified_files.all_files)} files')
    _file_names = ','.join([identified_files.individual_files.keys()])
    logging.debug(f'all files identified {_file_names}')
    virus_total_results = []
    logging.info('Checking files MD5 hash against VirusTotal Repository')
    for file_name, metadata in identified_files.individual_files.items():
        virus_total_results.append(VirusTotalUtils.VirusTotalScan(metadata['md5'], file_name))
    logging.info('Generating scan report')
    _report = '\n\n'.join([file.report for file in virus_total_results])
    _generated_report = reporting.virus_total_report_template.format(report=_report)
    _report_name = f'{datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")}'
    _report_path = f'{tempfile.gettempdir()}/scan_report_{_report_name}.txt'
    _write_file = open(f'{_report_path}', "w")
    _write_file(_generated_report)
    _write_file.close()
    logging.info(f'Scan report generated at {_report_path}')