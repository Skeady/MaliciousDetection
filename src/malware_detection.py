import datetime
import logging
import os
import shutil
import tempfile

import SystemScanner
import VirusTotalUtils
from reporting import report_generation_template, execution_wrap_up
from tqdm import tqdm
logging.getLogger(__name__)


# Used to call the appropriate modules
def run_file_scan(file_path):
    logging.info('Starting SystemScan')
    print('Starting SystemScan on host be patient this can take a while')
    identified_files = SystemScanner.Scan(file_path)
    number_of_identified_files = len(identified_files.all_files)
    logging.info(f'SystemScan identified {number_of_identified_files} files')
    file_names = ','.join(list(identified_files.individual_files.keys()))
    logging.debug(f'all files identified {file_names}')

    virus_total_results = []
    logging.info('Checking files MD5 hash against VirusTotal Repository')
    print(f"\n{number_of_identified_files} Files identified checking them against VirusTotal")
    for file_name, metadata in tqdm(identified_files.individual_files.items()):
        logging.debug(f'Running on {file_name}: {metadata["md5"]}')
        virus_total_response = VirusTotalUtils.VirusTotalScan(metadata['md5'],
                                                              file_name
        )
        virus_total_results.append(virus_total_response)

    logging.info('Generating scan report')
    all_reports = []
    print("\nCreating the report")
    for file in tqdm(virus_total_results):
        if int(file.virus_total_response.get('results').get('response_code')) == 1:
            all_reports.append(file.report)

    report = '\n\n'.join(all_reports)
    generated_report = report_generation_template.format(report=report)
    string_timestamp = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    report_name = f'malware-detection-scan_{string_timestamp}.txt'

    directory, path = tempfile.mkstemp()
    report_binary = bytes(generated_report, encoding='utf-8')
    os.write(directory, report_binary)
    os.close(directory)
    shutil.copy(path, report_name)
    os.remove(path)
    identifed_file_benign_files = None 
    if identified_files.benign_files:
        list(identified_files.benign_files.keys())
    logging.info(f"List of benign files: {identifed_file_benign_files}")
    print(execution_wrap_up.format(identifed_file_benign_files=identifed_file_benign_files,
                                   total_files_checked=number_of_identified_files,
                                   report_name=report_name
            )
    )